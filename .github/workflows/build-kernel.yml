name: Build RM6785 Kernel (Storm Salaa)

on:
  workflow_dispatch:
    inputs:
      kernel_branch:
        description: 'Kernel Branch'
        required: true
        type: string
        default: 'bq1'
      enable_ksu:
        description: 'Enable KernelSU'
        required: true
        type: boolean
        default: false
      ksu_variant:
        description: 'KernelSU Variant'
        required: false
        type: choice
        options:
          - 'RKSU'
          - 'xxKSU'
          - 'SukiSU'
          - 'KSU-Next'
        default: 'RKSU'
      enable_susfs:
        description: 'Enable SUSFS'
        required: false
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ARCH: arm64
      SUBARCH: arm64
      KERNEL_REPO: "https://github.com/StimLuks87/storm_kernel_realme_salaa.git"
      CLANG_REPO: "https://gitlab.com/crdroidandroid/android_prebuilts_clang_host_linux-x86_clang-r547379.git"
      ANYKERNEL_REPO: "https://github.com/Luks-organization/KerneSU_AnyKernel3.git"
      ANYKERNEL_BRANCH: "master"
      DEFCONFIG: "salaa_defconfig"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Build Environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential bc bison flex libssl-dev gcc clang lld git zip unzip curl ccache libelf-dev python3

      - name: Clone Kernel Source
        run: |
          git clone --depth=1 "$KERNEL_REPO" -b "${{ github.event.inputs.kernel_branch }}" kernel

      - name: Clone Toolchain
        run: |
          git clone --depth=1 "$CLANG_REPO" clang

      # --- KernelSU Setup (Gunakan logic setup.sh yang sebelumnya) ---
      # ... (Sisipkan logic Setup KernelSU di sini)

      - name: Build Kernel
        working-directory: kernel
        run: |
          export PATH="${GITHUB_WORKSPACE}/clang/bin:${PATH}"
          export KBUILD_BUILD_USER="StimLuks87"
          export KBUILD_BUILD_HOST="Storm-Build"
          
          make O=out ARCH=arm64 ${DEFCONFIG}
          
          make -j$(nproc --all) O=out \
              ARCH=arm64 \
              CC="ccache clang" \
              CLANG_TRIPLE=aarch64-linux-gnu- \
              CROSS_COMPILE=aarch64-linux-gnu- \
              CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
              LLVM=1 \
              LLVM_IAS=1 \
              CONFIG_NO_ERROR_ON_MISMATCH=y

      - name: Manual Concatenate DTB (Fix for Salaa/RUI3)
        working-directory: kernel/out
        run: |
          # Cek jika Image.gz-dtb belum ada, kita buat manual
          if [ ! -f arch/arm64/boot/Image.gz-dtb ]; then
            echo "Image.gz-dtb not found, creating it manually..."
            cat arch/arm64/boot/Image.gz arch/arm64/boot/dts/mediatek/mt6785.dtb > arch/arm64/boot/Image.gz-dtb
          fi
          
          # Cek keberadaan DTBO
          if [ -f arch/arm64/boot/dtbo.img ]; then
            echo "DTBO_EXISTS=true" >> $GITHUB_ENV
          fi

      - name: Package with AnyKernel3
        run: |
          git clone --depth=1 "$ANYKERNEL_REPO" -b "$ANYKERNEL_BRANCH" AnyKernel
          
          # Gunakan Image.gz-dtb yang baru dibuat
          cp kernel/out/arch/arm64/boot/Image.gz-dtb AnyKernel/Image.gz
          
          # Sertakan DTBO jika ada (Sangat penting untuk RUI 3.0)
          if [ "${{ env.DTBO_EXISTS }}" == "true" ]; then
            cp kernel/out/arch/arm64/boot/dtbo.img AnyKernel/
          fi
          
          cd AnyKernel
          TIMESTAMP=$(date +"%Y%m%d-%H%M")
          ZIP_NAME="Storm-Salaa-RUI3-${TIMESTAMP}"
          zip -r9 "../${ZIP_NAME}.zip" *
          echo "ZIP_NAME=${ZIP_NAME}" >> $GITHUB_ENV

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ./*.zip
