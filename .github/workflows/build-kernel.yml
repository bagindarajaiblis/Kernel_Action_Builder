name: Build RM6785 Kernel

on:
  workflow_dispatch:
    inputs:
      kernel_branch:
        description: 'Kernel Branch'
        required: true
        type: string
        default: 'bq1'
      
      enable_ksu:
        description: 'Enable KernelSU'
        required: true
        type: boolean
        default: false
      
      ksu_variant:
        description: 'KernelSU Variant (only if KSU enabled)'
        required: false
        type: choice
        options:
          - 'RKSU'
          - 'xxKSU'
          - 'SukiSU'
        default: 'RKSU'
      
      enable_susfs:
        description: 'Enable SUSFS (only works with RKSU/SukiSU)'
        required: false
        type: boolean
        default: false
      
      custom_note:
        description: 'Custom build note (optional)'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ARCH: arm64
      SUBARCH: arm64
      LC_ALL: C
      USE_CCACHE: 1
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      KERNEL_REPO: "https://github.com/StimLuks87/storm_kernel_realme_salaa.git"
      CLANG_REPO: "https://gitlab.com/crdroidandroid/android_prebuilts_clang_host_linux-x86_clang-r547379.git"
      ANYKERNEL_REPO: "https://github.com/Luks-organization/KerneSU_AnyKernel3.git"
      ANYKERNEL_BRANCH: "master"
      DEFCONFIG: "salaa_defconfig"

    steps:
      - name: Checkout Workflow Repository
        uses: actions/checkout@v4

      - name: Set up Build Environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential bc bison flex libssl-dev \
            gcc clang lld libncurses5-dev git zip unzip \
            curl wget time ccache libelf-dev libfdt-dev \
            python3 python3-pip

      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-rm6785-${{ github.sha }}
          restore-keys: |
            ccache-rm6785-

      - name: Configure ccache
        run: |
          ccache --max-size=5G
          ccache --set-config=compression=true
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV

      - name: Clone Kernel Source
        run: |
          git clone --depth=1 "$KERNEL_REPO" -b "${{ github.event.inputs.kernel_branch }}" kernel
          cd kernel
          echo "KERNEL_DIR=$(pwd)" >> $GITHUB_ENV
          echo "KERNEL_VERSION=$(make kernelversion 2>/dev/null || echo 'unknown')" >> $GITHUB_ENV
          echo "KERNEL_BRANCH=${{ github.event.inputs.kernel_branch }}" >> $GITHUB_ENV

      - name: Cache Clang Toolchain
        uses: actions/cache@v4
        id: cache-clang
        with:
          path: clang
          key: clang-r547379

      - name: Clone Clang Toolchain
        if: steps.cache-clang.outputs.cache-hit != 'true'
        run: |
          git clone --depth=1 "$CLANG_REPO" clang

      - name: Setup KernelSU - RKSU
        if: github.event.inputs.enable_ksu == 'true' && github.event.inputs.ksu_variant == 'RKSU'
        working-directory: kernel
        run: |
          echo "Setting up RKSU..."
          if [ "${{ github.event.inputs.enable_susfs }}" == "true" ]; then
            echo "Installing RKSU with SUSFS support..."
            curl -LSs "https://raw.githubusercontent.com/rsuntk/KernelSU/susfs-rksu-master/kernel/setup.sh" | bash -s susfs-rksu-master
            echo "KSU_VARIANT=RKSU" >> $GITHUB_ENV
            echo "SUSFS_ENABLED=true" >> $GITHUB_ENV
            echo "KSU_MANAGER_URL=https://github.com/rsuntk/KernelSU/releases/latest" >> $GITHUB_ENV
          else
            echo "Installing RKSU without SUSFS..."
            curl -LSs "https://raw.githubusercontent.com/rsuntk/KernelSU/main/kernel/setup.sh" | bash -s main
            echo "KSU_VARIANT=RKSU" >> $GITHUB_ENV
            echo "SUSFS_ENABLED=false" >> $GITHUB_ENV
            echo "KSU_MANAGER_URL=https://github.com/rsuntk/KernelSU/releases/latest" >> $GITHUB_ENV
          fi

      - name: Setup KernelSU - xxKSU
        if: github.event.inputs.enable_ksu == 'true' && github.event.inputs.ksu_variant == 'xxKSU'
        working-directory: kernel
        run: |
          echo "Setting up xxKSU..."
          curl -LSs "https://raw.githubusercontent.com/backslashxx/KernelSU/master/kernel/setup.sh" | bash -s master
          echo "KSU_VARIANT=xxKSU" >> $GITHUB_ENV
          echo "SUSFS_ENABLED=false" >> $GITHUB_ENV
          echo "KSU_MANAGER_URL=https://github.com/backslashxx/KernelSU/releases/latest" >> $GITHUB_ENV
          
          if [ "${{ github.event.inputs.enable_susfs }}" == "true" ]; then
            echo "âš ï¸ Warning: xxKSU does not support SUSFS. Ignoring SUSFS flag."
          fi

      - name: Setup KernelSU - SukiSU
        if: github.event.inputs.enable_ksu == 'true' && github.event.inputs.ksu_variant == 'SukiSU'
        working-directory: kernel
        run: |
          echo "Setting up SukiSU..."
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/builtin/kernel/setup.sh" | bash -s builtin
          echo "KSU_VARIANT=SukiSU" >> $GITHUB_ENV
          echo "KSU_MANAGER_URL=https://github.com/SukiSU-Ultra/SukiSU-Ultra/releases/latest" >> $GITHUB_ENV
          
          if [ "${{ github.event.inputs.enable_susfs }}" == "true" ]; then
            echo "SUSFS_ENABLED=true" >> $GITHUB_ENV
          else
            echo "SUSFS_ENABLED=false" >> $GITHUB_ENV
          fi

      - name: Configure KernelSU
        if: github.event.inputs.enable_ksu == 'true'
        working-directory: kernel
        run: |
          DEFCONFIG_PATH="arch/arm64/configs/$DEFCONFIG"
          
          echo "Adding KSU configuration..."
          echo "CONFIG_KSU=y" >> "$DEFCONFIG_PATH"
          
          # Add SUSFS configs if enabled and supported
          if [ "${{ github.event.inputs.enable_susfs }}" == "true" ] && [ "$SUSFS_ENABLED" == "true" ]; then
            echo "Adding SUSFS configurations..."
            cat >> "$DEFCONFIG_PATH" << 'EOF'
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
          CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          # CONFIG_KSU_SUSFS_SUS_MAP is not set
          EOF
            echo "âœ… SUSFS configurations added"
          fi

      - name: Set Build Variant for Stock
        if: github.event.inputs.enable_ksu == 'false'
        run: |
          echo "KSU_VARIANT=Stock" >> $GITHUB_ENV
          echo "SUSFS_ENABLED=false" >> $GITHUB_ENV

      - name: Build Kernel
        id: build_kernel
        working-directory: kernel
        run: |
          set -e
          echo "Starting kernel build..."
          start_time=$(date +%s)

          export PATH="${GITHUB_WORKSPACE}/clang/bin:${PATH}"
          export KBUILD_BUILD_USER="elohim-etz"
          export KBUILD_BUILD_HOST="GitHub-Actions"

          mkdir -p out
          
          make O=out ARCH=${ARCH} ${DEFCONFIG}
          
          make -j$(nproc --all) O=out \
              ARCH=${ARCH} \
              CC="ccache clang" \
              LLVM=1 \
              LLVM_IAS=1 \
              CROSS_COMPILE=aarch64-linux-gnu- \
              CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
              CONFIG_NO_ERROR_ON_MISMATCH=y

          end_time=$(date +%s)
          build_duration=$((end_time - start_time))
          echo "BUILD_DURATION=${build_duration}" >> $GITHUB_ENV
          echo "Build completed in ${build_duration}s"

      - name: Check Build Output
        id: check_output
        working-directory: kernel
        run: |
          if [ ! -f "out/arch/arm64/boot/Image.gz" ]; then
            echo "âŒ Error: Image.gz not found! Build failed."
            exit 1
          fi
          
          IMAGE_SIZE=$(stat -c%s "out/arch/arm64/boot/Image.gz")
          IMAGE_SIZE_MB=$(echo "scale=2; $IMAGE_SIZE / 1048576" | bc)
          echo "IMAGE_SIZE_MB=${IMAGE_SIZE_MB}" >> $GITHUB_ENV
          echo "âœ… Kernel image found: ${IMAGE_SIZE_MB} MB"

      - name: Package with AnyKernel3
        id: zip_kernel
        run: |
          echo "Packaging kernel with AnyKernel3..."
          rm -rf AnyKernel
          git clone --depth=1 "$ANYKERNEL_REPO" -b "$ANYKERNEL_BRANCH" AnyKernel
          
          cp kernel/out/arch/arm64/boot/Image.gz AnyKernel/
          
          cd AnyKernel
          TIMESTAMP=$(date +"%Y%m%d-%H%M")
          
          # Build zip name based on variant and SUSFS status
          if [ "${{ github.event.inputs.enable_ksu }}" == "true" ]; then
            if [ "$SUSFS_ENABLED" == "true" ]; then
              ZIP_NAME="Miku-RM6785-${KSU_VARIANT}-SUSFS-${TIMESTAMP}"
            else
              ZIP_NAME="Miku-RM6785-${KSU_VARIANT}-${TIMESTAMP}"
            fi
          else
            ZIP_NAME="Miku-RM6785-Stock-${TIMESTAMP}"
          fi
          
          zip -r9 "${ZIP_NAME}.zip" * > /dev/null 2>&1
          
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
          echo "ANYKERNEL_DIR=$(pwd)" >> $GITHUB_ENV
          echo "âœ… Kernel packaged: ${ZIP_NAME}.zip"

      - name: Upload Kernel Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ${{ env.ANYKERNEL_DIR }}/${{ env.ZIP_NAME }}.zip
          retention-days: 30

      - name: Get KSU Version Info
        if: github.event.inputs.enable_ksu == 'true'
        id: ksu_info
        run: |
          case "${{ github.event.inputs.ksu_variant }}" in
            "RKSU")
              if [ "${{ github.event.inputs.enable_susfs }}" == "true" ]; then
                BRANCH="susfs-rksu-master"
              else
                BRANCH="main"
              fi
              KSU_COMMIT=$(git ls-remote https://github.com/rsuntk/KernelSU.git $BRANCH | cut -f1 | cut -c1-7)
              echo "KSU_COMMIT=$KSU_COMMIT" >> $GITHUB_ENV
              echo "KSU_COMMIT_URL=https://github.com/rsuntk/KernelSU/commit/$KSU_COMMIT" >> $GITHUB_ENV
              ;;
            "xxKSU")
              KSU_COMMIT=$(git ls-remote https://github.com/backslashxx/KernelSU.git master | cut -f1 | cut -c1-7)
              echo "KSU_COMMIT=$KSU_COMMIT" >> $GITHUB_ENV
              echo "KSU_COMMIT_URL=https://github.com/backslashxx/KernelSU/commit/$KSU_COMMIT" >> $GITHUB_ENV
              ;;
            "SukiSU")
              KSU_COMMIT=$(git ls-remote https://github.com/SukiSU-Ultra/SukiSU-Ultra.git builtin | cut -f1 | cut -c1-7)
              echo "KSU_COMMIT=$KSU_COMMIT" >> $GITHUB_ENV
              echo "KSU_COMMIT_URL=https://github.com/SukiSU-Ultra/SukiSU-Ultra/commit/$KSU_COMMIT" >> $GITHUB_ENV
              ;;
          esac

      - name: Send Success Notification to Telegram
        if: success()
        run: |
          duration_min=$((BUILD_DURATION / 60))
          duration_sec=$((BUILD_DURATION % 60))
          commit_hash="$(cd kernel && git rev-parse --short HEAD)"
          job_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          note="${{ github.event.inputs.custom_note }}"
          
          # Build message
          MESSAGE="ğŸ‰ *Kernel Build Successful!*%0A%0A"
          MESSAGE+="ğŸ“± *Device:* RM6785%0A"
          MESSAGE+="ğŸ”¢ *Kernel Version:* ${KERNEL_VERSION}%0A"
          MESSAGE+="ğŸ·ï¸ *Build Variant:* ${KSU_VARIANT}"
          
          if [ "$SUSFS_ENABLED" == "true" ]; then
            MESSAGE+=" + SUSFS"
          fi
          MESSAGE+="%0A"
          
          MESSAGE+="ğŸ’¾ *Image Size:* ${IMAGE_SIZE_MB} MB%0A"
          MESSAGE+="ğŸŒ¿ *Branch:* ${KERNEL_BRANCH}%0A"
          MESSAGE+="ğŸ“ *Commit:* [\`${commit_hash}\`](https://github.com/elohim-etz/android_kernel_realme_mt6785/commit/${commit_hash})%0A"
          MESSAGE+="â±ï¸ *Build Time:* ${duration_min}m ${duration_sec}s%0A"
          
          if [ "${{ github.event.inputs.enable_ksu }}" == "true" ]; then
            MESSAGE+="%0A*KernelSU Info:*%0A"
            MESSAGE+="â”œ Variant: ${{ github.event.inputs.ksu_variant }}%0A"
            MESSAGE+="â”œ Commit: [\`${KSU_COMMIT}\`](${KSU_COMMIT_URL})%0A"
            
            if [ "$SUSFS_ENABLED" == "true" ]; then
              MESSAGE+="â”œ SUSFS: âœ… Enabled%0A"
            else
              MESSAGE+="â”œ SUSFS: âŒ Disabled%0A"
            fi
            
            # Add manager link
            case "${{ github.event.inputs.ksu_variant }}" in
              "RKSU")
                MESSAGE+="â”” Manager: [Download RKSU Manager](${KSU_MANAGER_URL})%0A"
                ;;
              "xxKSU")
                MESSAGE+="â”” Manager: [Download xxKSU Manager](${KSU_MANAGER_URL})%0A"
                ;;
              "SukiSU")
                MESSAGE+="â”” Manager: [Download SukiSU Manager](${KSU_MANAGER_URL})%0A"
                ;;
            esac
          fi
          
          if [ -n "$note" ]; then
            MESSAGE+="%0AğŸ“Œ *Note:* ${note}%0A"
          fi
          
          MESSAGE+="%0AğŸ“¦ [Download Kernel](${job_url})%0A"
          MESSAGE+="ğŸ”— [View Workflow](${job_url})"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="Markdown" \
            -d text="${MESSAGE}" \
            -d disable_web_page_preview=true

      - name: Send Failure Notification to Telegram
        if: failure()
        run: |
          commit_hash="$(cd kernel && git rev-parse --short HEAD 2>/dev/null || echo 'N/A')"
          job_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          note="${{ github.event.inputs.custom_note }}"
          
          MESSAGE="âŒ *Kernel Build Failed!*%0A%0A"
          MESSAGE+="ğŸ“± *Device:* RM6785%0A"
          MESSAGE+="ğŸ·ï¸ *Build Variant:* "
          
          if [ "${{ github.event.inputs.enable_ksu }}" == "true" ]; then
            MESSAGE+="${{ github.event.inputs.ksu_variant }}"
            if [ "${{ github.event.inputs.enable_susfs }}" == "true" ]; then
              MESSAGE+=" + SUSFS"
            fi
          else
            MESSAGE+="Stock"
          fi
          MESSAGE+="%0A"
          
          MESSAGE+="ğŸŒ¿ *Branch:* ${{ github.event.inputs.kernel_branch }}%0A"
          MESSAGE+="ğŸ“ *Commit:* [\`${commit_hash}\`](https://github.com/elohim-etz/android_kernel_realme_mt6785/commit/${commit_hash})%0A"
          
          if [ -n "$note" ]; then
            MESSAGE+="%0AğŸ“Œ *Note:* ${note}%0A"
          fi
          
          MESSAGE+="%0AğŸ”— [View Error Logs](${job_url})"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="Markdown" \
            -d text="${MESSAGE}" \
            -d disable_web_page_preview=true
