name: Build RM6785 Kernel

on:
  workflow_dispatch:
    inputs:
      kernel_branch:
        description: 'Kernel Branch'
        required: true
        type: string
        default: 'bq1'
      
      enable_ksu:
        description: 'Enable KernelSU'
        required: true
        type: boolean
        default: false
      
      ksu_variant:
        description: 'KernelSU Variant (only if KSU enabled)'
        required: false
        type: choice
        options:
          - 'RKSU'
          - 'xxKSU'
          - 'SukiSU'
          - 'KSU-Next'
        default: 'RKSU'
      
      enable_susfs:
        description: 'Enable SUSFS (Recommended for RKSU/SukiSU/KSU-Next)'
        required: false
        type: boolean
        default: false
      
      custom_note:
        description: 'Custom build note (optional)'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ARCH: arm64
      SUBARCH: arm64
      LC_ALL: C
      USE_CCACHE: 1
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      KERNEL_REPO: "https://github.com/StimLuks87/storm_kernel_realme_salaa.git"
      CLANG_REPO: "https://gitlab.com/crdroidandroid/android_prebuilts_clang_host_linux-x86_clang-r547379.git"
      ANYKERNEL_REPO: "https://github.com/Luks-organization/KerneSU_AnyKernel3.git"
      ANYKERNEL_BRANCH: "master"
      DEFCONFIG: "RM6785_defconfig"

    steps:
      - name: Checkout Workflow Repository
        uses: actions/checkout@v4

      - name: Set up Build Environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential bc bison flex libssl-dev \
            gcc clang lld libncurses5-dev git zip unzip \
            curl wget time ccache libelf-dev libfdt-dev \
            python3 python3-pip

      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-rm6785-${{ github.sha }}
          restore-keys: |
            ccache-rm6785-

      - name: Configure ccache
        run: |
          ccache --max-size=5G
          ccache --set-config=compression=true
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV

      - name: Clone Kernel Source
        run: |
          git clone --depth=1 "$KERNEL_REPO" -b "${{ github.event.inputs.kernel_branch }}" kernel
          cd kernel
          echo "KERNEL_DIR=$(pwd)" >> $GITHUB_ENV
          echo "KERNEL_VERSION=$(make kernelversion 2>/dev/null || echo 'unknown')" >> $GITHUB_ENV
          echo "KERNEL_BRANCH=${{ github.event.inputs.kernel_branch }}" >> $GITHUB_ENV

      - name: Cache Clang Toolchain
        uses: actions/cache@v4
        id: cache-clang
        with:
          path: clang
          key: clang-r547379

      - name: Clone Clang Toolchain
        if: steps.cache-clang.outputs.cache-hit != 'true'
        run: |
          git clone --depth=1 "$CLANG_REPO" clang

      # --- KernelSU Setup Logic ---

      - name: Setup KernelSU - RKSU
        if: github.event.inputs.enable_ksu == 'true' && github.event.inputs.ksu_variant == 'RKSU'
        working-directory: kernel
        run: |
          if [ "${{ github.event.inputs.enable_susfs }}" == "true" ]; then
            curl -LSs "https://raw.githubusercontent.com/rsuntk/KernelSU/susfs-rksu-master/kernel/setup.sh" | bash -s susfs-rksu-master
            echo "SUSFS_ENABLED=true" >> $GITHUB_ENV
          else
            curl -LSs "https://raw.githubusercontent.com/rsuntk/KernelSU/main/kernel/setup.sh" | bash -s main
            echo "SUSFS_ENABLED=false" >> $GITHUB_ENV
          fi
          echo "KSU_VARIANT=RKSU" >> $GITHUB_ENV
          echo "KSU_MANAGER_URL=https://github.com/rsuntk/KernelSU/releases/latest" >> $GITHUB_ENV

      - name: Setup KernelSU - xxKSU
        if: github.event.inputs.enable_ksu == 'true' && github.event.inputs.ksu_variant == 'xxKSU'
        working-directory: kernel
        run: |
          curl -LSs "https://raw.githubusercontent.com/backslashxx/KernelSU/master/kernel/setup.sh" | bash -s master
          echo "KSU_VARIANT=xxKSU" >> $GITHUB_ENV
          echo "SUSFS_ENABLED=false" >> $GITHUB_ENV
          echo "KSU_MANAGER_URL=https://github.com/backslashxx/KernelSU/releases/latest" >> $GITHUB_ENV

      - name: Setup KernelSU - SukiSU
        if: github.event.inputs.enable_ksu == 'true' && github.event.inputs.ksu_variant == 'SukiSU'
        working-directory: kernel
        run: |
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/builtin/kernel/setup.sh" | bash -s builtin
          echo "KSU_VARIANT=SukiSU" >> $GITHUB_ENV
          echo "KSU_MANAGER_URL=https://github.com/SukiSU-Ultra/SukiSU-Ultra/releases/latest" >> $GITHUB_ENV
          [ "${{ github.event.inputs.enable_susfs }}" == "true" ] && echo "SUSFS_ENABLED=true" >> $GITHUB_ENV || echo "SUSFS_ENABLED=false" >> $GITHUB_ENV

      - name: Setup KernelSU - KSU-Next
        if: github.event.inputs.enable_ksu == 'true' && github.event.inputs.ksu_variant == 'KSU-Next'
        working-directory: kernel
        run: |
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main
          echo "KSU_VARIANT=KSU-Next" >> $GITHUB_ENV
          echo "KSU_MANAGER_URL=https://github.com/tiann/KernelSU/releases/latest" >> $GITHUB_ENV
          [ "${{ github.event.inputs.enable_susfs }}" == "true" ] && echo "SUSFS_ENABLED=true" >> $GITHUB_ENV || echo "SUSFS_ENABLED=false" >> $GITHUB_ENV

      - name: Configure KernelSU & SUSFS
        if: github.event.inputs.enable_ksu == 'true'
        working-directory: kernel
        run: |
          DEFCONFIG_PATH="arch/arm64/configs/$DEFCONFIG"
          echo "CONFIG_KSU=y" >> "$DEFCONFIG_PATH"
          if [ "$SUSFS_ENABLED" == "true" ]; then
            cat >> "$DEFCONFIG_PATH" << 'EOF'
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
          CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          EOF
          fi

      - name: Build Kernel
        id: build_kernel
        working-directory: kernel
        run: |
          set -e
          export PATH="${GITHUB_WORKSPACE}/clang/bin:${PATH}"
          export KBUILD_BUILD_USER="StimLuks87"
          export KBUILD_BUILD_HOST="GitHub-Actions"
          mkdir -p out
          make O=out ARCH=${ARCH} ${DEFCONFIG}
          make -j$(nproc --all) O=out \
              ARCH=${ARCH} \
              CC="ccache clang" \
              LLVM=1 \
              LLVM_IAS=1 \
              CROSS_COMPILE=aarch64-linux-gnu- \
              CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
              CONFIG_NO_ERROR_ON_MISMATCH=y

      - name: Package with AnyKernel3
        id: zip_kernel
        run: |
          git clone --depth=1 "$ANYKERNEL_REPO" -b "$ANYKERNEL_BRANCH" AnyKernel
          cp kernel/out/arch/arm64/boot/Image.gz AnyKernel/
          cd AnyKernel
          TIMESTAMP=$(date +"%Y%m%d-%H%M")
          ZIP_NAME="Storm-RM6785-${{ env.KSU_VARIANT || 'Stock' }}-${TIMESTAMP}"
          [ "$SUSFS_ENABLED" == "true" ] && ZIP_NAME="${ZIP_NAME}-SUSFS"
          zip -r9 "${ZIP_NAME}.zip" *
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
          echo "ANYKERNEL_DIR=$(pwd)" >> $GITHUB_ENV

      - name: Upload Kernel Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ${{ env.ANYKERNEL_DIR }}/${{ env.ZIP_NAME }}.zip

      - name: Send Notification
        if: always()
        run: |
          # Logika Telegram tetap sama, menyesuaikan variabel yang ada
          # ... (sama seperti base yml anda)
